<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crear Comercio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <style> body { font-family: 'Kanit', sans-serif; } </style>
  <script src="../shared/loader.js"></script>
</head>
<body class="bg-gray-50">

  <main class="px-4 py-6 max-w-xl mx-auto">
    <h2 class="text-2xl font-semibold mb-4 text-center">Nuevo Comercio</h2>

    <div class="grid grid-cols-1 gap-4">
      <input type="text" id="nombre" placeholder="Nombre del Comercio" class="border px-3 py-2 rounded" />
      <input type="text" id="telefono" placeholder="Tel√©fono" class="border px-3 py-2 rounded" />
      <input type="text" id="direccion" placeholder="Direcci√≥n" class="border px-3 py-2 rounded" />
      
      <select id="municipio" class="border px-3 py-2 rounded">
        <option value="">Seleccionar Municipio</option>
      </select>

      <input type="text" id="latitud" placeholder="Latitud" class="border px-3 py-2 rounded" />
      <input type="text" id="longitud" placeholder="Longitud" class="border px-3 py-2 rounded" />

      <select id="categoria" class="border px-3 py-2 rounded">
        <option value="">Seleccionar Categor√≠a</option>
      </select>
      <select id="subcategoria" class="border px-3 py-2 rounded">
        <option value="">Seleccionar Subcategor√≠a</option>
      </select>
    </div>

    <button id="crearBtn" class="mt-6 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
      Crear Comercio
    </button>
  </main>

  <script type="module" src="js/crearComercio.js"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://zgjaxanqfkweslkxtayt.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnamF4YW5xZmt3ZXNsa3h0YXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyNzk3NjgsImV4cCI6MjA2Mjg1NTc2OH0.Abif2Fu2uHyby--t_TAacEbjG8jCxmgsCbLx6AinT6c'
    );

    const municipioSelect = document.getElementById('municipio');
    const categoriaSelect = document.getElementById('categoria');
    const subcategoriaSelect = document.getElementById('subcategoria');

    async function cargarMunicipios() {
      const { data, error } = await supabase.from('Municipios').select('id, nombre');
      if (error) return console.error('Error cargando municipios:', error);
      data.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.nombre;
        municipioSelect.appendChild(opt);
      });
    }

    async function cargarCategorias() {
      const { data, error } = await supabase.from('Categorias').select('id, nombre');
      if (error) return console.error('Error cargando categor√≠as:', error);
      data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nombre;
        categoriaSelect.appendChild(opt);
      });
    }

    async function cargarSubcategorias() {
      const idCat = parseInt(categoriaSelect.value);
      if (isNaN(idCat)) {
        subcategoriaSelect.innerHTML = '<option value="">Seleccionar Subcategor√≠a</option>';
        return;
      }

      const { data, error } = await supabase.from('subCategoria').select('id, nombre').eq('idCategoria', idCat);
      if (error) return console.error('Error cargando subcategor√≠as:', error);

      subcategoriaSelect.innerHTML = '<option value="">Seleccionar Subcategor√≠a</option>';
      data.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.nombre;
        subcategoriaSelect.appendChild(opt);
      });
    }

    categoriaSelect.addEventListener('change', cargarSubcategorias);

    document.getElementById('crearBtn').addEventListener('click', async () => {
      const nombre = document.getElementById('nombre').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const direccion = document.getElementById('direccion').value.trim();
      const idMunicipio = parseInt(municipioSelect.value);
      const idCategoria = parseInt(categoriaSelect.value);
      const idSubcategoria = parseInt(subcategoriaSelect.value);
      const latitud = parseFloat(document.getElementById('latitud').value);
      const longitud = parseFloat(document.getElementById('longitud').value);

      if (!nombre || !telefono || !direccion || isNaN(idMunicipio) || isNaN(idCategoria)) {
        alert('Faltan campos requeridos.');
        return;
      }

      // üîÑ Buscar el idArea seg√∫n el municipio seleccionado
      const { data: munData, error: munError } = await supabase
        .from('Municipios')
        .select('idArea')
        .eq('id', idMunicipio)
        .single();

      if (munError || !munData?.idArea) {
        alert('Error obteniendo el √°rea del municipio');
        return;
      }

      const idArea = munData.idArea;

      const { error } = await supabase.from('Comercios').insert({
        nombre, telefono, direccion,
        idMunicipio, idCategoria,
        idSubcategoria: isNaN(idSubcategoria) ? null : idSubcategoria,
        latitud, longitud,
        idArea,
        activo: true
      });

      if (error) {
        alert('‚ùå Error creando comercio');
        console.error(error);
      } else {
        alert('‚úÖ Comercio creado exitosamente');
        location.href = 'adminComercios.html';
      }
    });

    cargarMunicipios();
    cargarCategorias();
  </script>
</body>
</html>
